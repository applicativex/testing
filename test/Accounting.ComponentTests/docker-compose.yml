version: '3.1'

services:
  integration:
    build: 
      context: .
      dockerfile: Accounting.ComponentTests/Dockerfile
    depends_on:
      - betstore
    entrypoint: bash /integration/wait_for_it.sh accounting:80 -t 0 -- dotnet test ./Accounting.ComponentTests/Accounting.ComponentTests.csproj

  accounting:
    build: .
    environment:
      - ASPNETCORE_ENVIRONMENT=Integration
      - ASPNETCORE_URLS=http://*:80
    depends_on: 
      - db
      - rabbitmq
    entrypoint: bash /app/wait_for_it.sh rabbitmq:5672 -t 0 -- dotnet /app/Accounting.Host.dll

  db:
    image: postgres
    restart: always
    volumes:
      - ./Accounting.ComponentTests/init.sql:/docker-entrypoint-initdb.d/init.sql
  
  rabbitmq:
    image: rabbitmq:3